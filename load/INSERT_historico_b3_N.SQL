INSERT INTO dados_b3.historico_b3_N
SELECT 
D0.DATAPREG AS D0_DATAPREG,
D0.CODNEG,
D0.NOMRES,
DE.EMPRESA,
D0.week,
D0.MONTH,
D0.YEAR,
D0.day_1,	
D0.day_2,	
D0.day_3,	
D0.day_4,	
D0.day_5,	
D0.week_2_w,
D0.week_2_y,
D0.week_3_w,
D0.week_3_y,
D0.week_4_w,
D0.week_4_y,
D0.month_2_w,
D0.month_2_y,
D0.month_3_w,
D0.month_3_y,
D0.month_4_w,
D0.month_4_y,
D0.PREABE AS PREABE_D0,
D0.PREULT AS PREULT_D0,
CAST(D0.QUATOT AS INT64) AS QUATOT_D0,
(D0.PREULT- D0.PREABE) AS VARI_D0,

COALESCE(D1.PREABE, D2.PREULT, D3.PREULT) AS PREABE_D1,
COALESCE(D1.PREMAX, D2.PREULT, D3.PREULT) AS PREMAX_D1,
COALESCE(D1.PREMIN, D2.PREULT, D3.PREULT) AS PREMIN_D1, 
COALESCE(D1.PREMD_, D2.PREULT, D3.PREULT) AS PREMD__D1,
COALESCE(D1.PREULT, D2.PREULT, D3.PREULT) AS PREULT_D1,
COALESCE(D1.PREOFC, D2.PREULT, D3.PREULT) AS PREOFC_D1,
COALESCE(D1.PREOFV, D2.PREULT, D3.PREULT) AS PREOFV_D1,
CAST(COALESCE(D1.QUATOT, D2.QUATOT, D3.QUATOT) AS INT64) AS QUATOT_D1,
(COALESCE(D1.PREULT, 0)- COALESCE(D1.PREABE, 0)) AS VARI_D1,

COALESCE(D2.PREABE, D3.PREULT, D4.PREULT) AS PREABE_D2,
COALESCE(D2.PREMAX, D3.PREULT, D4.PREULT) AS PREMAX_D2,
COALESCE(D2.PREMIN, D3.PREULT, D4.PREULT) AS PREMIN_D2, 
COALESCE(D2.PREMD_, D3.PREULT, D4.PREULT) AS PREMD__D2,
COALESCE(D2.PREULT, D3.PREULT, D4.PREULT) AS PREULT_D2,
COALESCE(D2.PREOFC, D3.PREULT, D4.PREULT) AS PREOFC_D2,
COALESCE(D2.PREOFV, D3.PREULT, D4.PREULT) AS PREOFV_D2,
CAST(COALESCE(D2.QUATOT, D3.QUATOT, D4.QUATOT) AS INT64) AS QUATOT_D2,
(COALESCE(D2.PREULT, 0)- COALESCE(D2.PREABE, 0)) AS VARI_D2,

COALESCE(D3.PREABE, D4.PREULT, D5.PREULT) AS PREABE_D3,
COALESCE(D3.PREMAX, D4.PREULT, D5.PREULT) AS PREMAX_D3,
COALESCE(D3.PREMIN, D4.PREULT, D5.PREULT) AS PREMIN_D3, 
COALESCE(D3.PREMD_, D4.PREULT, D5.PREULT) AS PREMD__D3,
COALESCE(D3.PREULT, D4.PREULT, D5.PREULT) AS PREULT_D3,
COALESCE(D3.PREOFC, D4.PREULT, D5.PREULT) AS PREOFC_D3,
COALESCE(D3.PREOFV, D4.PREULT, D5.PREULT) AS PREOFV_D3,
CAST(COALESCE(D3.QUATOT, D4.QUATOT, D5.QUATOT) AS INT64) AS QUATOT_D3,
(COALESCE(D3.PREULT, 0)- COALESCE(D3.PREABE, 0)) AS VARI_D3,

COALESCE(D4.PREABE, D5.PREULT,D3.PREABE) AS PREABE_D4,
COALESCE(D4.PREMAX, D5.PREULT,D3.PREABE) AS PREMAX_D4,
COALESCE(D4.PREMIN, D5.PREULT,D3.PREABE) AS PREMIN_D4, 
COALESCE(D4.PREMD_, D5.PREULT,D3.PREABE) AS PREMD__D4,
COALESCE(D4.PREULT, D5.PREULT,D3.PREABE) AS PREULT_D4,
COALESCE(D4.PREOFC, D5.PREULT,D3.PREABE) AS PREOFC_D4,
COALESCE(D4.PREOFV, D5.PREULT,D3.PREABE) AS PREOFV_D4,
CAST(COALESCE(D4.QUATOT, D5.QUATOT, D3.QUATOT) AS INT64) AS QUATOT_D4,
(COALESCE(D4.PREULT, 0)- COALESCE(D4.PREABE, 0)) AS VARI_D4,

COALESCE(D5.PREABE, D4.PREABE,D3.PREABE) AS PREABE_D5,
COALESCE(D5.PREMAX, D4.PREABE,D3.PREABE) AS PREMAX_D5,
COALESCE(D5.PREMIN, D4.PREABE,D3.PREABE) AS PREMIN_D5, 
COALESCE(D5.PREMD_, D4.PREABE,D3.PREABE) AS PREMD__D5,
COALESCE(D5.PREULT, D4.PREABE,D3.PREABE) AS PREULT_D5,
COALESCE(D5.PREOFC, D4.PREABE,D3.PREABE) AS PREOFC_D5,
COALESCE(D5.PREOFV, D4.PREABE,D3.PREABE) AS PREOFV_D5,
CAST(COALESCE(D5.QUATOT, D4.QUATOT, D3.QUATOT) AS INT64) AS QUATOT_D5,
(COALESCE(D5.PREULT, D4.PREABE,D3.PREABE) - COALESCE(D4.PREABE, D4.PREABE,D3.PREABE)) AS VARI_D5,

AVG(W2.PREABE) AS PREABE_W2,
AVG(W2.PREMAX) AS PREMAX_W2,
AVG(W2.PREMIN) AS PREMIN_W2, 
AVG(W2.PREMD_) AS PREMD__W2,
AVG(W2.PREULT) AS PREULT_W2,
AVG(W2.PREOFC) AS PREOFC_W2,
AVG(W2.PREOFV) AS PREOFV_W2,
AVG(W2.QUATOT) AS QUATOT_W2,
(AVG(W2.PREULT) - AVG(W2.PREABE)) AS VARI_W2,

AVG(W3.PREABE) AS PREABE_W3,
AVG(W3.PREMAX) AS PREMAX_W3,
AVG(W3.PREMIN) AS PREMIN_W3, 
AVG(W3.PREMD_) AS PREMD__W3,
AVG(W3.PREULT) AS PREULT_W3,
AVG(W3.PREOFC) AS PREOFC_W3,
AVG(W3.PREOFV) AS PREOFV_W3,
AVG(W3.QUATOT) AS QUATOT_W3,
(AVG(W3.PREULT) - AVG(W3.PREABE)) AS VARI_W3,

AVG(W4.PREABE) AS PREABE_W4,
AVG(W4.PREMAX) AS PREMAX_W4,
AVG(W4.PREMIN) AS PREMIN_W4, 
AVG(W4.PREMD_) AS PREMD__W4,
AVG(W4.PREULT) AS PREULT_W4,
AVG(W4.PREOFC) AS PREOFC_W4,
AVG(W4.PREOFV) AS PREOFV_W4,
AVG(W4.QUATOT) AS QUATOT_W4,
(AVG(W4.PREULT) - AVG(W4.PREABE)) AS VARI_W4,

AVG(M2.PREABE) AS PREABE_M2,
AVG(M2.PREMAX) AS PREMAX_M2,
AVG(M2.PREMIN) AS PREMIN_M2, 
AVG(M2.PREMD_) AS PREMD__M2,
AVG(M2.PREULT) AS PREULT_M2,
AVG(M2.PREOFC) AS PREOFC_M2,
AVG(M2.PREOFV) AS PREOFV_M2,
AVG(M2.QUATOT) AS QUATOT_M2,
(AVG(M2.PREULT) - AVG(M2.PREABE)) AS VARI_M2,

AVG(M3.PREABE) AS PREABE_M3,
AVG(M3.PREMAX) AS PREMAX_M3,
AVG(M3.PREMIN) AS PREMIN_M3, 
AVG(M3.PREMD_) AS PREMD__M3,
AVG(M3.PREULT) AS PREULT_M3,
AVG(M3.PREOFC) AS PREOFC_M3,
AVG(M3.PREOFV) AS PREOFV_M3,
AVG(M3.QUATOT) AS QUATOT_M3,
(AVG(M3.PREULT) - AVG(M3.PREABE)) AS VARI_M3


FROM dados_b3.dadosb3_datas D0

LEFT JOIN `dados_b3.DE_PARA_EMPRESAS`  DE
	ON DE.CODNEG = D0.CODNEG


LEFT JOIN dados_b3.dadosb3_datas D1
	on d1.DATAPREG = D0.DAY_1
	AND D1.CODNEG = D0.CODNEG

LEFT JOIN dados_b3.dadosb3_datas D2
	on D2.DATAPREG = D0.DAY_2
	AND D2.CODNEG = D0.CODNEG

LEFT JOIN dados_b3.dadosb3_datas D3
	on D3.DATAPREG = D0.DAY_3
	AND D3.CODNEG = D0.CODNEG

LEFT JOIN dados_b3.dadosb3_datas D4
	on D4.DATAPREG = D0.DAY_4
	AND D4.CODNEG = D0.CODNEG

LEFT JOIN dados_b3.dadosb3_datas D5
	on D5.DATAPREG = D0.DAY_5
	AND D5.CODNEG = D0.CODNEG

LEFT JOIN dados_b3.dadosb3_datas W2
	on W2.WEEK = D0.week_2_w
	AND W2.YEAR = D0.week_2_y
	AND W2.CODNEG = D0.CODNEG


LEFT JOIN dados_b3.dadosb3_datas W3
	on W3.WEEK = D0.week_3_w
	AND W3.YEAR = D0.week_3_y
	AND W3.CODNEG = D0.CODNEG


LEFT JOIN dados_b3.dadosb3_datas W4
	on W4.WEEK = D0.week_4_w
	AND W4.YEAR = D0.week_4_y
	AND W4.CODNEG = D0.CODNEG


LEFT JOIN dados_b3.dadosb3_datas M2
	on M2.MONTH = D0.month_2_w
	AND M2.YEAR = D0.month_2_Y
	AND M2.CODNEG = D0.CODNEG


LEFT JOIN dados_b3.dadosb3_datas M3
	on M3.MONTH = D0.month_3_w
	AND M3.YEAR = D0.month_3_Y
	AND M3.CODNEG = D0.CODNEG


WHERE D0.DATAPREG > (SELECT MAX(D0_DATAPREG) FROM dados_b3.historico_b3_N)
--D0.DATAPREG >= '2017-01-01'
--WHERE D0.DATAPREG BETWEEN '2019-01-01' AND '2019-01-10'
--AND D0.CODNEG = 'PETR4'
AND D0.CODNEG IN (
'IDVL4',
'GSHP3',
'INEP4',
'PRIO3',
'QGEP3',
'BPAC11',
'BPAN4',
'JBSS3',
'BEEF3',
'CSNA3',
'GFSA3',
'FHER3',
'VIVR3',
'DMMO3',
'PDGR3',
'AZEV4',
'LPSB3',
'TSLA34',
'FJTA3',
'RSID3'
)
GROUP BY 1,2,3,4,5,6,7,8,9,10,
        11,12,13,14,15,16,17,18,19,20,
        21,22,23,24,25,26,27,28,29,30,
        31,32,33,34,35,36,37,38,39,40,
        41,42,43,44,45,46,47,48,49,50,
        51,52,53,54,55,56,57,58,59,60,
        61,62,63,64,65,66,67,68,69,70,
        71,72,73
ORDER BY D0.DATAPREG
;


